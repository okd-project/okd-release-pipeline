---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: create-github-release
spec:
  params:
    - description: This is the token generated by the GitHub App using the task get-github-access-token
      name: token
      type: string
    - description: The release name to target
      name: release-name
      type: string
    - description: The GitHub org/repo to release to
      name: github-org-repo
      type: string
      default: cheesesashimi/okd-release-test
    - description: Determines if the release should be tagged latest
      type: string
      name: is-latest
      default: "false"
  steps:
    - image: "quay.io/okd/tekton-worker:latest"
      name: "create-github-release"
      env:
        - name: RELEASE_NAME
          value: $(params.release-name)
        - name: GH_TOKEN
          value: $(params.token)
        - name: IS_LATEST
          value: $(params.is-latest)
      script: |
        #!/usr/bin/env bash
        set -euxo pipefail

        FLAG="--prerelease"
        if $IS_LATEST ; then
          FLAG="--latest"
        fi

        cd "$(workspaces.release-binaries.path)/$RELEASE_NAME"

        # Create a new GitHub release and upload our assets
        # See: https://cli.github.com/ for details 
        # on the official GitHub CLI tool
        gh release create "$RELEASE_NAME" \
          -t "$RELEASE_NAME" \
          --repo "$(params.github-org-repo)" \
          $FLAG --notes-file release-notes.txt \
          ./*.tar.gz ./*.txt ./*.txt.asc ./*.zip
  workspaces:
    - name: release-binaries
      description: The location we store the signed release binaries in
      mountPath: /var/release-binaries
